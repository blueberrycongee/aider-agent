<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aider Agent - ‰ªìÂ∫ìÁÆ°ÁêÜ</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 40px;
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d4ff, #7c3aed);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .add-repo-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .input-group {
            display: flex;
            gap: 12px;
        }
        
        .input-group input {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }
        
        .input-group input:focus {
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px #7c3aed;
        }
        
        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #7c3aed, #00d4ff);
            color: #fff;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(124, 58, 237, 0.4);
        }
        
        .btn-start {
            background: linear-gradient(90deg, #10b981, #059669);
            color: #fff;
            padding: 10px 20px;
            font-size: 14px;
        }
        
        .btn-start:hover {
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
        }
        
        .btn-start:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-delete {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            padding: 10px 16px;
            font-size: 14px;
        }
        
        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        .repo-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .repo-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }
        
        .repo-card:hover {
            border-color: rgba(124, 58, 237, 0.5);
        }
        
        .repo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .repo-name {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .repo-url {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.875rem;
            margin-top: 4px;
            word-break: break-all;
        }
        
        .repo-actions {
            display: flex;
            gap: 10px;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending { background: rgba(107, 114, 128, 0.3); color: #9ca3af; }
        .status-cloning { background: rgba(59, 130, 246, 0.3); color: #60a5fa; }
        .status-cloned { background: rgba(16, 185, 129, 0.3); color: #34d399; }
        .status-reviewing { background: rgba(245, 158, 11, 0.3); color: #fbbf24; }
        .status-fixing { background: rgba(168, 85, 247, 0.3); color: #c084fc; }
        .status-completed { background: rgba(16, 185, 129, 0.3); color: #34d399; }
        .status-error { background: rgba(239, 68, 68, 0.3); color: #f87171; }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }
        
        .github-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
        }
        
        .github-status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .github-status .dot.connected { background: #34d399; }
        .github-status .dot.disconnected { background: #f87171; }
        
        .issues-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .issues-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .issues-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.75rem;
        }
        
        .issue-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .issue-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            gap: 12px;
        }
        
        .issue-info {
            flex: 1;
            min-width: 0;
        }
        
        .issue-title {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .issue-title a {
            color: #60a5fa;
            text-decoration: none;
        }
        
        .issue-title a:hover {
            text-decoration: underline;
        }
        
        .issue-meta {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .issue-labels {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 6px;
        }
        
        .issue-label {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            background: rgba(124, 58, 237, 0.3);
            color: #c4b5fd;
        }
        
        .difficulty-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .difficulty-1 { background: rgba(16, 185, 129, 0.3); color: #34d399; }
        .difficulty-2 { background: rgba(52, 211, 153, 0.3); color: #6ee7b7; }
        .difficulty-3 { background: rgba(251, 191, 36, 0.3); color: #fcd34d; }
        .difficulty-4 { background: rgba(251, 146, 60, 0.3); color: #fdba74; }
        .difficulty-5 { background: rgba(239, 68, 68, 0.3); color: #fca5a5; }
        
        .btn-fix {
            background: linear-gradient(90deg, #8b5cf6, #6366f1);
            color: #fff;
            padding: 6px 12px;
            font-size: 0.75rem;
            white-space: nowrap;
        }
        
        .btn-fix:hover {
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }
        
        .btn-fix:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .loading-issues {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .status-message {
            margin-top: 12px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .output-section {
            margin-top: 16px;
        }
        
        .output-toggle {
            color: #7c3aed;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .output-content {
            margin-top: 12px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 0.75s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Aider Agent</h1>
        
        <div class="header-bar">
            <div class="github-status" id="githubStatus">
                <span class="dot disconnected"></span>
                <span>GitHub: Êú™ËøûÊé•</span>
            </div>
            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5);">
                ‰ªìÂ∫ìÊï∞: <span id="taskCount">0</span>
            </div>
        </div>
        
        <div class="add-repo-section">
            <div class="input-group">
                <input type="text" id="repoUrl" placeholder="ËæìÂÖ• GitHub ‰ªìÂ∫ìÂú∞ÂùÄÔºå‰æãÂ¶ÇÔºöhttps://github.com/owner/repo">
                <button class="btn btn-primary" onclick="addRepo()">Ê∑ªÂä†‰ªìÂ∫ì</button>
            </div>
        </div>
        
        <div class="repo-list" id="repoList">
            <div class="empty-state" id="emptyState">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                </svg>
                <p>ËøòÊ≤°ÊúâÊ∑ªÂä†‰ªìÂ∫ì<br>ËæìÂÖ• GitHub ‰ªìÂ∫ìÂú∞ÂùÄÂºÄÂßã</p>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const repos = {};
        const repoIssues = {};  // Â≠òÂÇ®ÊØè‰∏™‰ªìÂ∫ìÁöÑ Issues
        
        // ÁõëÂê¨Áä∂ÊÄÅÊõ¥Êñ∞
        socket.on('status_update', (data) => {
            if (repos[data.id]) {
                repos[data.id].status = data.status;
                repos[data.id].message = data.message;
                renderRepos();
            }
        });
        
        // ÁõëÂê¨ Aider ËæìÂá∫
        socket.on('aider_output', (data) => {
            if (repos[data.id]) {
                if (!repos[data.id].output) repos[data.id].output = '';
                repos[data.id].output += data.line + '\n';
                updateOutput(data.id);
            }
        });
        
        // Ëé∑ÂèñÁ≥ªÁªüÁä∂ÊÄÅ
        function fetchStatus() {
            fetch('/api/status')
            .then(res => res.json())
            .then(status => {
                const el = document.getElementById('githubStatus');
                const countEl = document.getElementById('taskCount');
                
                if (status.github_connected) {
                    el.innerHTML = `<span class="dot connected"></span><span>GitHub: ${status.github_user}</span>`;
                } else {
                    el.innerHTML = `<span class="dot disconnected"></span><span>GitHub: Êú™ËøûÊé• (ËÆæÁΩÆ GITHUB_TOKEN)</span>`;
                }
                
                countEl.textContent = status.task_count;
            })
            .catch(() => {});
        }
        
        function addRepo() {
            const input = document.getElementById('repoUrl');
            const url = input.value.trim();
            
            if (!url) {
                alert('ËØ∑ËæìÂÖ•‰ªìÂ∫ìÂú∞ÂùÄ');
                return;
            }
            
            fetch('/api/repos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            })
            .then(res => res.json())
            .then(repo => {
                repos[repo.id] = repo;
                input.value = '';
                renderRepos();
                fetchStatus();
            })
            .catch(err => alert('Ê∑ªÂä†Â§±Ë¥•: ' + err));
        }
        
        function startTask(id) {
            fetch(`/api/repos/${id}/start`, { method: 'POST' })
            .then(res => res.json())
            .then(() => {
                repos[id].status = 'cloning';
                repos[id].message = '‰ªªÂä°ÂêØÂä®‰∏≠...';
                repos[id].output = '';
                renderRepos();
            })
            .catch(err => alert('ÂêØÂä®Â§±Ë¥•: ' + err));
        }
        
        function deleteRepo(id) {
            if (!confirm('Á°ÆÂÆöÂà†Èô§Ëøô‰∏™‰ªìÂ∫ìÂêóÔºü')) return;
            
            fetch(`/api/repos/${id}`, { method: 'DELETE' })
            .then(() => {
                delete repos[id];
                delete repoIssues[id];
                renderRepos();
                fetchStatus();
            });
        }
        
        function toggleOutput(id) {
            const el = document.getElementById(`output-${id}`);
            if (el) {
                el.style.display = el.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function toggleIssues(id) {
            const el = document.getElementById(`issues-${id}`);
            if (el) {
                const isHidden = el.style.display === 'none';
                el.style.display = isHidden ? 'block' : 'none';
                if (isHidden && !repoIssues[id]) {
                    fetchIssues(id);
                }
            }
        }
        
        function fetchIssues(id) {
            const listEl = document.getElementById(`issue-list-${id}`);
            if (listEl) {
                listEl.innerHTML = '<div class="loading-issues"><span class="spinner"></span> Ê≠£Âú®Ëé∑Âèñ Issues...</div>';
            }
            
            fetch(`/api/repos/${id}/issues`)
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    listEl.innerHTML = `<div class="loading-issues">‚ùå ${data.error}</div>`;
                    return;
                }
                repoIssues[id] = data.issues;
                renderIssueList(id);
            })
            .catch(err => {
                listEl.innerHTML = `<div class="loading-issues">‚ùå Ëé∑ÂèñÂ§±Ë¥•</div>`;
            });
        }
        
        function renderIssueList(id) {
            const listEl = document.getElementById(`issue-list-${id}`);
            const issues = repoIssues[id] || [];
            
            if (issues.length === 0) {
                listEl.innerHTML = '<div class="loading-issues">ÊöÇÊó†ÂèØ‰øÆÂ§çÁöÑ Issues</div>';
                return;
            }
            
            listEl.innerHTML = issues.map(issue => `
                <div class="issue-item">
                    <div class="issue-info">
                        <div class="issue-title">
                            <span class="difficulty-badge difficulty-${issue.difficulty_score || 3}">
                                ÈöæÂ∫¶ ${issue.difficulty_score || '?'}
                            </span>
                            <a href="${issue.url}" target="_blank">#${issue.number}</a>
                            ${issue.title}
                        </div>
                        <div class="issue-meta">${issue.recommendation || ''}</div>
                        <div class="issue-labels">
                            ${issue.labels.map(l => `<span class="issue-label">${l}</span>`).join('')}
                        </div>
                    </div>
                    <button class="btn btn-fix" onclick="fixIssue('${id}', ${issue.number})" 
                            ${repos[id]?.status === 'fixing' ? 'disabled' : ''}>
                        üîß ‰øÆÂ§ç
                    </button>
                </div>
            `).join('');
        }
        
        function fixIssue(repoId, issueNumber) {
            if (!confirm(`Á°ÆÂÆöË¶ÅËÆ© AI ‰øÆÂ§ç Issue #${issueNumber} ÂêóÔºü`)) return;
            
            fetch(`/api/repos/${repoId}/issues/${issueNumber}/fix`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert('‰øÆÂ§çÂ§±Ë¥•: ' + data.error);
                    return;
                }
                repos[repoId].status = 'fixing';
                repos[repoId].message = data.message;
                renderRepos();
            })
            .catch(err => alert('ËØ∑Ê±ÇÂ§±Ë¥•: ' + err));
        }
        
        function updateOutput(id) {
            const el = document.getElementById(`output-content-${id}`);
            if (el) {
                el.textContent = repos[id].output || '';
                el.scrollTop = el.scrollHeight;
            }
        }
        
        function getStatusText(status) {
            const map = {
                'pending': 'Á≠âÂæÖ‰∏≠',
                'cloning': 'ÂÖãÈöÜ‰∏≠',
                'cloned': 'Â∑≤ÂÖãÈöÜ',
                'reviewing': 'ÂÆ°Êü•‰∏≠',
                'fixing': '‰øÆÂ§ç‰∏≠',
                'completed': 'Â∑≤ÂÆåÊàê',
                'error': 'ÈîôËØØ'
            };
            return map[status] || status;
        }
        
        function renderRepos() {
            const list = document.getElementById('repoList');
            const repoIds = Object.keys(repos);
            
            if (repoIds.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                        </svg>
                        <p>ËøòÊ≤°ÊúâÊ∑ªÂä†‰ªìÂ∫ì<br>ËæìÂÖ• GitHub ‰ªìÂ∫ìÂú∞ÂùÄÂºÄÂßã</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = repoIds.map(id => {
                const repo = repos[id];
                const isRunning = ['cloning', 'reviewing', 'fixing'].includes(repo.status);
                const hasOutput = repo.output && repo.output.length > 0;
                const canShowIssues = ['cloned', 'completed', 'error'].includes(repo.status);
                
                return `
                    <div class="repo-card">
                        <div class="repo-header">
                            <div>
                                <div class="repo-name">${repo.name}</div>
                                <div class="repo-url">${repo.url}</div>
                            </div>
                            <div class="repo-actions">
                                <span class="status-badge status-${repo.status}">
                                    ${isRunning ? '<span class="spinner"></span>' : ''}
                                    ${getStatusText(repo.status)}
                                </span>
                                <button class="btn btn-start" onclick="startTask('${id}')" ${isRunning ? 'disabled' : ''}>
                                    ${isRunning ? 'ËøêË°å‰∏≠...' : 'ÂºÄÂßã‰ªªÂä°'}
                                </button>
                                <button class="btn btn-delete" onclick="deleteRepo('${id}')">Âà†Èô§</button>
                            </div>
                        </div>
                        ${repo.message ? `<div class="status-message">${repo.message}</div>` : ''}
                        ${hasOutput ? `
                            <div class="output-section">
                                <span class="output-toggle" onclick="toggleOutput('${id}')">üìã Êü•Áúã Aider ËæìÂá∫</span>
                                <div id="output-${id}" style="display:none;">
                                    <div class="output-content" id="output-content-${id}">${repo.output}</div>
                                </div>
                            </div>
                        ` : ''}
                        ${canShowIssues ? `
                            <div class="issues-section">
                                <div class="issues-header">
                                    <span class="issues-title">üìã Issues</span>
                                    <button class="btn btn-small btn-primary" onclick="toggleIssues('${id}')">
                                        ${repoIssues[id] ? 'Âà∑Êñ∞' : 'Âä†ËΩΩ'} Issues
                                    </button>
                                </div>
                                <div id="issues-${id}" style="display:${repoIssues[id] ? 'block' : 'none'};">
                                    <div class="issue-list" id="issue-list-${id}">
                                        ${repoIssues[id] ? '' : '<div class="loading-issues">ÁÇπÂáª‰∏äÊñπÊåâÈíÆÂä†ËΩΩ Issues</div>'}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            // ÈáçÊñ∞Ê∏≤ÊüìÂ∑≤Âä†ËΩΩÁöÑ Issues
            Object.keys(repoIssues).forEach(id => {
                if (repoIssues[id]) renderIssueList(id);
            });
        }
        
        // Enter ÈîÆÊ∑ªÂä†‰ªìÂ∫ì
        document.getElementById('repoUrl').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addRepo();
        });
        
        // ‰ªéÂêéÁ´ØÂä†ËΩΩ‰ªìÂ∫ìÂàóË°®
        function loadRepos() {
            fetch('/api/repos')
            .then(res => res.json())
            .then(data => {
                data.forEach(repo => {
                    repos[repo.id] = repo;
                });
                renderRepos();
            })
            .catch(() => {});
        }
        
        // ÂàùÂßãÂåñ
        fetchStatus();
        loadRepos();
        
        // ÂÆöÊó∂Âà∑Êñ∞Áä∂ÊÄÅÂíå‰ªìÂ∫ìÂàóË°®
        setInterval(fetchStatus, 30000);
        setInterval(loadRepos, 5000);  // ÊØè5ÁßíÂà∑Êñ∞‰ªìÂ∫ìÁä∂ÊÄÅ
    </script>
</body>
</html>
